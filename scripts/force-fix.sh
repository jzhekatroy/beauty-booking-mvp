#!/bin/bash

echo "üî• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js/npm –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–µ–π—á–∞—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000
echo "üìä –¢–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000:"
netstat -punta | grep 3000 || echo "–ü–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω"

# –£–±–∏–≤–∞–µ–º next-server (–æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)
echo "üéØ –£–±–∏–≤–∞–µ–º next-server –ø—Ä–æ—Ü–µ—Å—Å—ã..."
sudo pkill -9 -f "next-server" || true

# –°–Ω–∞—á–∞–ª–∞ –º—è–≥–∫–æ
sudo pkill -f "npm start" || true
sudo pkill -f "node" || true
sudo pkill -f "npm" || true
sleep 2

# –ü–æ—Ç–æ–º –∂–µ—Å—Ç–∫–æ
sudo pkill -9 -f "npm start" || true
sudo pkill -9 -f "node" || true
sudo pkill -9 -f "npm" || true
sleep 2

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000 –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
echo "üîì –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000..."
sudo fuser -k 3000/tcp || true
sleep 1
sudo fuser -9 -k 3000/tcp || true

# –£–±–∏–≤–∞–µ–º –≤—Å–µ —á—Ç–æ –≤–∏—Å–∏—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000 –ø–æ PID
PIDS=$(sudo lsof -t -i:3000 2>/dev/null || true)
if [ ! -z "$PIDS" ]; then
    echo "üî´ –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000: $PIDS"
    sudo kill -9 $PIDS || true
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ netstat
NETSTAT_PIDS=$(netstat -punta | grep ':3000' | awk '{print $7}' | cut -d'/' -f1 | grep -v '^-$' || true)
if [ ! -z "$NETSTAT_PIDS" ]; then
    echo "üéØ –£–±–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ netstat: $NETSTAT_PIDS"
    echo "$NETSTAT_PIDS" | xargs -r sudo kill -9 || true
fi

sleep 3

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω:"
netstat -punta | grep 3000 || echo "‚úÖ –ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω!"

# –ó–∞—â–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
echo "üõ°Ô∏è –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏..."
chmod +x scripts/protect-database.sh
./scripts/protect-database.sh

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
sudo chown -R beautyapp:beautyapp /home/beautyapp/beauty-booking
sudo chmod 664 /home/beautyapp/beauty-booking/prisma/dev.db || true

# –û—á–∏—â–∞–µ–º –∫—ç—à
echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à..."
sudo rm -rf /home/beautyapp/beauty-booking/.next
sudo rm -rf /home/beautyapp/beauty-booking/node_modules/.cache

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
cd /home/beautyapp/beauty-booking
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; then
    echo "üì• –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    sudo -u beautyapp npm ci
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–±–µ–∑ setup-env.sh)
echo "‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
if [ ! -f .env ]; then
    echo "‚ö†Ô∏è .env —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º setup-env.sh"
    echo "üõ°Ô∏è –ó–ê–©–ò–¢–ê: setup-env.sh –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
    echo "üìã –°–æ–∑–¥–∞–π—Ç–µ .env –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ–Ω –µ—Å—Ç—å"
else
    echo "üìÅ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚úÖ"
fi

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ -f prisma/dev.db ]; then
    sudo chmod 664 prisma/dev.db || true
    echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
sudo -u beautyapp npm run build

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
cd /home/beautyapp/beauty-booking
sudo -u beautyapp nohup npm start > nohup.out 2>&1 &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —É–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –µ—Å—Ç—å
OLD_PIDS=$(sudo lsof -t -i:3000 2>/dev/null | grep -v $(pgrep -f "npm start" | head -1) || true)
if [ ! -z "$OLD_PIDS" ]; then
    echo "üßπ –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: $OLD_PIDS"
    sudo kill -9 $OLD_PIDS || true
    sleep 2
fi

if pgrep -f "npm start" > /dev/null; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
    echo "üìä –ü—Ä–æ—Ü–µ—Å—Å—ã: $(pgrep -f 'npm start' | wc -l)"
    echo "üîå –ü–æ—Ä—Ç 3000: $(sudo lsof -i:3000 2>/dev/null | wc -l) —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
    for i in {1..3}; do
        if curl -s http://localhost:3000/api/status > /dev/null; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã! (–ø–æ–ø—ã—Ç–∫–∞ $i)"
            break
        else
            echo "‚è≥ –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ $i)..."
            sleep 2
        fi
    done
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    if curl -s http://localhost:3000/api/status > /dev/null; then
        echo "üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!"
    else
        echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤:"
        tail -5 nohup.out || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤:"
    tail -10 nohup.out || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    exit 1
fi

echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
exit 0