name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check required secrets
      run: |
        if [ -z "${{ secrets.HOST }}" ]; then
          echo "❌ HOST secret is not set!"
          echo "Please add HOST to GitHub Secrets"
          exit 1
        fi
        if [ -z "${{ secrets.USERNAME }}" ]; then
          echo "❌ USERNAME secret is not set!"
          echo "Please add USERNAME to GitHub Secrets"
          exit 1
        fi
        if [ -z "${{ secrets.SSH_KEY }}" ]; then
          echo "❌ SSH_KEY secret is not set!"
          echo "Please add SSH_KEY to GitHub Secrets"
          exit 1
        fi
        echo "✅ All required secrets are configured"
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build Application
      run: npm run build
        
    - name: Deploy to Production Server
      run: |
        echo "🚀 Deploying to production server..."
        
        # Создаем SSH ключ из секрета
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
        
        # Подключаемся к серверу и деплоим
        echo "🔄 Deploying on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          cd /app
          
          # Останавливаем приложение
          echo "⏹️ Stopping application..."
          sudo pkill -f "npm start" || echo "App not running"
          
          # Получаем последние изменения
          echo "📥 Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Устанавливаем зависимости
          echo "📦 Installing dependencies..."
          npm ci
          
          # Генерируем Prisma Client
          echo "🔧 Generating Prisma Client..."
          npx prisma generate
          
          # Запускаем миграции
          echo "🔄 Running database migrations..."
          npx prisma migrate deploy
          
          # Собираем приложение
          echo "🔨 Building application..."
          sudo -u beautyapp npm run build
          
          # Запускаем приложение
          echo "🚀 Starting application..."
          sudo -u beautyapp nohup npm start > nohup.out 2>&1 &
          
          # Ждем запуска
          sleep 10
          
          # Проверяем что запустилось
          if curl -f http://localhost:3000/api/status > /dev/null 2>&1; then
            echo "✅ Application started successfully!"
          else
            echo "❌ Application failed to start, checking logs..."
            tail -20 nohup.out
            exit 1
          fi
          
          echo "✅ Deployment completed!"
        EOF
        
    - name: Health Check
      run: |
        echo "🔍 Running health check..."
        echo "✅ Deployment completed successfully!"
        echo "🌐 Check your production URL to verify"