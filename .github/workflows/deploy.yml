name: üöÄ Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üî® Build application
      run: npm run build
      
    - name: üß™ Run tests (if any)
      run: npm test --if-present
      
    - name: üöÄ Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π beauty-booking..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/beautyapp/beauty-booking
          echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          
          echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub..."
          git fetch origin
          git reset --hard origin/main
          echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $(git rev-parse --short HEAD)"
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm ci --production=false
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
          npm run build
          echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω"
          
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
          # –ù–∞—Ö–æ–¥–∏–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –±–æ–ª–µ–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
          if pgrep -f "npm start" > /dev/null; then
            echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å npm start, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
            sudo pkill -f "npm start" || echo "–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          else
            echo "–ü—Ä–æ—Ü–µ—Å—Å npm start –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000
          if sudo lsof -ti:3000 > /dev/null 2>&1; then
            echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
            sudo fuser -k 3000/tcp || echo "–ü–æ—Ä—Ç —É–∂–µ —Å–≤–æ–±–æ–¥–µ–Ω"
          fi
          
          echo "‚è≥ –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
          sleep 3
          
          echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
          sudo -u beautyapp bash -c "cd /home/beautyapp/beauty-booking && NODE_ENV=production PORT=3000 nohup npm start > app.log 2>&1 &"
          
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          sleep 8
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
          if pgrep -f "npm start" > /dev/null; then
            echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å npm start –∑–∞–ø—É—â–µ–Ω"
          else
            echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å npm start –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            tail -20 /home/beautyapp/beauty-booking/app.log || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health check
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º health check..."
          for i in {1..10}; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Health check –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!"
              echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://test.2minutes.ru"
              exit 0
            else
              echo "–ü–æ–ø—ã—Ç–∫–∞ $i/10: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç..."
              sleep 2
            fi
          done
          
          echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check –ø–æ—Å–ª–µ 20 —Å–µ–∫—É–Ω–¥"
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
          tail -20 /home/beautyapp/beauty-booking/app.log || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          echo "üîç –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
          ps aux | grep -E "(npm|node)" | grep -v grep || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ npm/node"
          exit 1
          
    - name: üìä Deployment status
      if: success()
      run: |
        echo "üéâ Deployment successful!"
        echo "üîó Check: http://test.2minutes.ru"
        
    - name: ‚ùå Deployment failed
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check the logs above for details"