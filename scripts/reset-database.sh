#!/bin/bash

echo "üö® –û–°–¢–û–†–û–ñ–ù–û: –°–ë–†–û–° –ë–ê–ó–´ –î–ê–ù–ù–´–•"
echo "================================"
echo ""
echo "üõ°Ô∏è  –û–ü–ï–†–ê–¶–ò–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –î–õ–Ø –ó–ê–©–ò–¢–´ –î–ê–ù–ù–´–•!"
echo ""

# –ó–ê–©–ò–¢–ê: —Ç—Ä–µ–±—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
if [ "$1" != "--force-delete-all-data" ]; then
    echo "‚ùå –û–ü–ï–†–ê–¶–ò–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê!"
    echo ""
    echo "‚ö†Ô∏è  –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –£–î–ê–õ–ò–¢ –í–°–ï –î–ê–ù–ù–´–ï –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:"
    echo "   - –í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–∞—Å—Ç–µ—Ä–æ–≤"
    echo "   - –í—Å–µ —É—Å–ª—É–≥–∏ –∏ –≥—Ä—É–ø–ø—ã —É—Å–ª—É–≥"
    echo "   - –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
    echo "   - –í—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    echo ""
    echo "–î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
    echo "  $0 --force-delete-all-data"
    echo ""
    echo "üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:"
    echo "  - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞: ./scripts/fix-database-permissions.sh"
    echo "  - –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø: ./scripts/protect-database.sh"
    echo "  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞: /home/beautyapp/db-backups/restore-latest.sh"
    echo ""
    exit 1
fi

echo "üîì –§–ª–∞–≥ --force-delete-all-data –ø–æ–ª—É—á–µ–Ω."
echo "‚ö†Ô∏è  –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –£–î–ê–õ–ò–¢ –í–°–ï –î–ê–ù–ù–´–ï –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:"
echo "   - –í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–∞—Å—Ç–µ—Ä–æ–≤"
echo "   - –í—Å–µ —É—Å–ª—É–≥–∏ –∏ –≥—Ä—É–ø–ø—ã —É—Å–ª—É–≥"
echo "   - –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
echo "   - –í—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
echo ""
echo "üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "prisma/schema.prisma" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
if [ -f "prisma/dev.db" ]; then
    echo "üìã –¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞: prisma/dev.db"
    echo "üìä –†–∞–∑–º–µ—Ä: $(du -h prisma/dev.db | cut -f1)"
    echo ""
fi

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "‚ùì –í—ã –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? (–≤–≤–µ–¥–∏—Ç–µ '–£–î–ê–õ–ò–¢–¨' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è): " confirmation

if [ "$confirmation" != "–£–î–ê–õ–ò–¢–¨" ]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."
    exit 0
fi

echo ""
echo "‚è≥ –ù–∞—á–∏–Ω–∞–µ–º —Å–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
if [ -f "prisma/dev.db" ]; then
    backup_name="prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)"
    echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: $backup_name"
    cp "prisma/dev.db" "$backup_name"
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pkill -f "npm start" 2>/dev/null || echo "   –ü—Ä–æ—Ü–µ—Å—Å—ã npm start –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
pkill -f "next" 2>/dev/null || echo "   –ü—Ä–æ—Ü–µ—Å—Å—ã Next.js –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
sleep 2

# –£–¥–∞–ª—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
rm -f prisma/dev.db

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üèóÔ∏è –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
if npx prisma db push; then
    echo "‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    exit 1
fi

# –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
echo "üå± –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."
if npm run db:seed; then
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
    exit 1
fi

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chmod 664 prisma/dev.db

echo ""
echo "üéâ –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "üîó –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:"
echo "   - –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω: admin@beauty-booking.com / admin123"
echo "   - –ê–¥–º–∏–Ω —Å–∞–ª–æ–Ω–∞: salon@example.com / password123"
echo "   - –ú–∞—Å—Ç–µ—Ä–∞: anna@example.com, elena@example.com / password123"
echo ""
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ prisma/ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .backup.*"
echo ""
echo "üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: npm start"