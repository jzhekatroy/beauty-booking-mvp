name: üö® Emergency Server Fix

on:
  workflow_dispatch:
    inputs:
      action:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ'
        required: true
        default: 'kill-port'
        type: choice
        options:
          - kill-port
          - full-restart
          - force-fix

jobs:
  emergency-fix:
    runs-on: ubuntu-latest
    steps:
    - name: üö® Emergency Fix - ${{ github.event.inputs.action }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        timeout: 180s
        script: |
          cd /home/beautyapp/beauty-booking
          
          if [ "${{ github.event.inputs.action }}" = "kill-port" ]; then
            echo "üî´ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000..."
            chmod +x scripts/kill-port-3000.sh
            ./scripts/kill-port-3000.sh
            
          elif [ "${{ github.event.inputs.action }}" = "full-restart" ]; then
            echo "üîÑ –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
            chmod +x scripts/kill-port-3000.sh
            ./scripts/kill-port-3000.sh
            sleep 3
            sudo -u beautyapp nohup npm start > nohup.out 2>&1 &
            sleep 5
            curl -s http://localhost:3000/api/status || echo "–°–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            
          elif [ "${{ github.event.inputs.action }}" = "force-fix" ]; then
            echo "üî• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
            chmod +x scripts/force-fix.sh
            ./scripts/force-fix.sh
          fi
          
          echo "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ '${{ github.event.inputs.action }}' –∑–∞–≤–µ—Ä—à–µ–Ω–æ"