#!/bin/bash

echo "๐ ะะธะฐะณะฝะพััะธะบะฐ ะธ ะฟะตัะตะทะฐะฟััะบ beauty-booking ะฟัะธะปะพะถะตะฝะธั"
echo "=================================================="

# ะะตัะตัะพะดะธะผ ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั
cd /home/beautyapp/beauty-booking

echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
echo "๐ค ะขะตะบััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั: $(whoami)"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั..."
sudo pkill -f "npm start" 2>/dev/null || echo "ะัะพัะตััั npm start ะฝะต ะฝะฐะนะดะตะฝั"
sudo fuser -k 3000/tcp 2>/dev/null || echo "ะะพัั 3000 ัะถะต ัะฒะพะฑะพะดะตะฝ"

# ะัะพะฒะตััะตะผ ัะฐะนะปั
echo "๐ ะัะพะฒะตััะตะผ ัะฐะนะปั..."
echo "  .env ัะฐะนะป: $([ -f .env ] && echo 'โ ะกััะตััะฒัะตั' || echo 'โ ะััััััะฒัะตั')"
echo "  ะะฐะทะฐ ะดะฐะฝะฝัั: $([ -f prisma/dev.db ] && echo 'โ ะกััะตััะฒัะตั' || echo 'โ ะััััััะฒัะตั')"
echo "  package.json: $([ -f package.json ] && echo 'โ ะกััะตััะฒัะตั' || echo 'โ ะััััััะฒัะตั')"

if [ -f .env ]; then
    echo "๐ ะกะพะดะตัะถะธะผะพะต .env:"
    cat .env | sed 's/JWT_SECRET=.*/JWT_SECRET=***HIDDEN***/'
else
    echo "โ .env ัะฐะนะป ะพััััััะฒัะตั! ะัะพะฟััะบะฐะตะผ ะฐะฒัะพ-ัะพะทะดะฐะฝะธะต ะฒ ัะตะปัั ะฑะตะทะพะฟะฐัะฝะพััะธ."
fi

# ะ ะฟัะพะดะฐะบัะตะฝะต ะฝะต ะฒัะฟะพะปะฝัะตะผ auto db push/seed
if [ "${NODE_ENV}" = "production" ]; then
    echo "๐ PROD ัะตะถะธะผ: ะฟัะพะฟััะบะฐะตะผ ะปัะฑัะต auto-ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะะ."
else
    if [ ! -f prisma/dev.db ]; then
        echo "๐๏ธ (DEV) ะะฐะทะฐ ะดะฐะฝะฝัั ะพััััััะฒัะตั. ะกะพะทะดะฐะตะผ..."
        npx prisma db push
        npm run db:seed
        echo "โ (DEV) ะะฐะทะฐ ะดะฐะฝะฝัั ัะพะทะดะฐะฝะฐ ะธ ะทะฐะฟะพะปะฝะตะฝะฐ"
    else
        echo "๐ง (DEV) ะัะฟัะฐะฒะปัะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ ะบ ะฑะฐะทะต ะดะฐะฝะฝัั..."
        chmod 664 prisma/dev.db 2>/dev/null || echo "ะัะฐะฒะฐ ัะถะต ะบะพััะตะบัะฝั"
    fi
fi

# ะัะฟัะฐะฒะปัะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
echo "๐ง ะัะฟัะฐะฒะปัะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ..."
sudo chown -R beautyapp:beautyapp /home/beautyapp/beauty-booking

# ะัะพะฑัะตะผ ะฟัะพัััั ะฟัะพะฒะตัะบั Node.js
echo "๐งช ะัะพะฒะตััะตะผ Node.js..."
node --version
npm --version

# ะัะพะฒะตััะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะัะพะฒะตััะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
if [ ! -d node_modules ]; then
    echo "๐ฅ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
    npm ci
fi

# ะฃะดะฐะปัะตะผ .next ะดะปั ัะธััะพะน ัะฑะพัะบะธ
echo "๐๏ธ ะัะธัะฐะตะผ ะบัั ัะฑะพัะบะธ..."
rm -rf .next

# ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั
echo "๐จ ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั..."
if npm run build; then
    echo "โ ะัะพะตะบั ัะพะฑัะฐะฝ ััะฟะตัะฝะพ"
else
    echo "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ ะฟัะพะตะบัะฐ"
    exit 1
fi

# ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต
echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
NODE_ENV=development PORT=3000 nohup npm start > app.log 2>&1 &
APP_PID=$!

echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 10

# ะัะพะฒะตััะตะผ ััะพ ะฟัะพัะตัั ะทะฐะฟัััะธะปัั
if kill -0 $APP_PID 2>/dev/null; then
    echo "โ ะัะพัะตัั ะทะฐะฟััะตะฝ (PID: $APP_PID)"
else
    echo "โ ะัะพัะตัั ะฝะต ะทะฐะฟัััะธะปัั"
    echo "๐ ะะพัะปะตะดะฝะธะต ัััะพะบะธ ะปะพะณะฐ:"
    tail -20 app.log
    exit 1
fi

# ะัะพะฒะตััะตะผ endpoints
echo "๐ ะัะพะฒะตััะตะผ endpoints..."

# ะัะพััะพะน ััะฐััั
if curl -f http://localhost:3000/api/status > /dev/null 2>&1; then
    echo "โ /api/status - ัะฐะฑะพัะฐะตั"
else
    echo "โ /api/status - ะฝะต ะพัะฒะตัะฐะตั"
fi

# Health check
if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "โ /api/health - ัะฐะฑะพัะฐะตั"
else
    echo "โ /api/health - ะฝะต ะพัะฒะตัะฐะตั"
fi

# Debug endpoint
if curl -f http://localhost:3000/api/debug > /dev/null 2>&1; then
    echo "โ /api/debug - ัะฐะฑะพัะฐะตั"
else
    echo "โ /api/debug - ะฝะต ะพัะฒะตัะฐะตั"
fi

echo ""
echo "๐ ะะธะฐะณะฝะพััะธะบะฐ ะทะฐะฒะตััะตะฝะฐ!"
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพะปะถะฝะพ ะฑััั ะดะพัััะฟะฝะพ ะฝะฐ: http://test.2minutes.ru"
echo "๐ ะะพะณะธ ะฟัะธะปะพะถะตะฝะธั: tail -f /home/beautyapp/beauty-booking/app.log"