### Календарь — техническая документация

### Обзор
Календарь в админ‑панели собирает расписание мастеров, их отсутствия и текущие бронирования, чтобы отрисовать посуточную сетку с тайм‑слотами и карточками записей. Основные файлы:
- `src/app/admin/page.tsx` — контейнер страницы админки, загрузка данных, модальное редактирование брони.
- `src/components/FullCalendar.tsx` — визуализация календарной сетки, навигация по неделям, позиционирование карточек бронирований, быстрые действия.
- `src/lib/timezone.ts` — утилиты часовых поясов.

### Поток данных и эндпоинты
- `GET /api/team/settings` — параметры команды (включая `timezone`).
- `GET /api/bookings` — актуальный список бронирований. На бекенде перед выдачей выполняется авто‑апдейт: все `CONFIRMED` с `endTime < now()` переводятся в `COMPLETED` (см. реализацию в соответствующем роуте).
- `GET /api/masters-list` — список мастеров.
- `GET /api/masters/:id/schedule` — расписание мастера по дням недели: рабочие интервалы, перерыв.
- `GET /api/masters/:id/absences` — отсутствия мастера по датам (диапазоны).
- Действия над конкретной бронью:
  - `PUT /api/bookings/:id` — сохранение изменений (время начала, мастер, длительность, цена, комментарий).
  - `POST /api/bookings/:id/cancel` — отмена предстоящей записи.
  - `POST /api/bookings/:id/no-show` — пометка «Не пришёл» для прошедшей записи.

Загрузка на странице (`src/app/admin/page.tsx`):
1) Параллельно: настройки команды, брони, мастера.
2) После мастеров — параллельно по каждому мастеру: расписания и отсутствия; затем объединение в общие массивы `masterSchedules`, `masterAbsences`.
3) Нормализация бронирований (имена клиента/услуг, длительность/цена услуг).
4) Автообновление раз в 60 секунд в тихом режиме.

### Часовые пояса
- Все визуальные расчёты времени производятся относительно часового пояса салона `salonTimezone` (из `team.settings.timezone`).
- В `FullCalendar.tsx` используются вспомогательные функции:
  - `formatHHmmInSalon(date)` — формат `HH:mm` в TZ салона.
  - `getSalonDateYYYYMMDD(date)` — дата `YYYY‑MM‑DD` в TZ салона (через `toLocaleDateString('en-CA', { timeZone })`).
  - Текущее время в минутах для «красной линии»: вычисление через локализованное `HH:mm`.
- Для вычислений конфликтов при редактировании используется `createDateInSalonTimezone(...)`.

### Сетка, расписания и отсутствия
- `masterSchedules`: элементы вида `{ masterId, dayOfWeek (0=вс), startTime, endTime, breakStart?, breakEnd? }`.
- `masterAbsences`: диапазоны отсутствий по датам в TZ салона.
- Логика подсветки слотов:
  - Нет расписания — серый фон `bg-gray-200` («Не работает»).
  - Вне рабочего времени — `bg-gray-100`.
  - Перерыв — `bg-gray-200` с меткой «Перерыв».
  - Отсутствие — `bg-gray-300` с причиной отсутствия.
  - Прошедшие слоты текущего дня заливаются полупрозрачным `bg-gray-100/70`.

### Навигация и выбор
- Выбор дня внутри недели (понедельник — старт недели), кнопки перелистывания недель, кнопка «Сегодня».
- Селектор мастера: отображение всех мастеров или только выбранного (`selectedMaster`).
- `activeMasters` определяется по выбору, влияет на ширину колонок календара.

### Позиционирование карточек бронирований
- Шаг сетки — 30 минут. Высота шага `SLOT_PX = 33` (32px + 1px граница).
- Базовая шкала времени выбирается по минимальному `startTime` и максимальному `endTime` среди всех активных мастеров на выбранную дату.
- Для каждой брони:
  - Время начала/конца читается как `HH:mm` в TZ салона.
  - `top = (startMinutes - baselineMinutes)/30 * SLOT_PX`.
  - `height = (durationMinutes/30) * SLOT_PX - 2`.
  - Горизонтальная позиция зависит от индекса мастера и ширины колонки.
- Карточка содержит: услугу (с `+N` для доп. услуг), строку мастера (если хватает высоты), строку клиента. Верхний крестик — быстрое действие отмены/«Не пришёл» (в зависимости от прошедшего/будущего статуса).

### Фильтрация бронирований для отрисовки
- `getMasterBookings(masterId)` фильтрует:
  - по выбранной дате `selectedDate`;
  - по мастеру;
  - исключает отменённые статусы: `CANCELLED_BY_CLIENT`, `CANCELLED_BY_SALON`.

### Редактирование брони (модалка)
- Открывается по клику на карточку в `src/app/admin/page.tsx`.
- Поля: `startTime` (datetime‑local, локальное значение), `masterId`, `duration`, `totalPrice`, `notes`.
- Проверка пересечений:
  - Пересечения считаются в TZ салона.
  - Считаются конфликты с другими записями того же мастера в статусах `NEW`, `CONFIRMED` (пересечение интервалов `newStart..newEnd` и `b.start..b.end`).
- Сохранение — `PUT /api/bookings/:id`; после успеха — перезагрузка данных, закрытие модалки.
- Быстрые действия в карточке: отмена предстоящей (`/cancel`) или «Не пришёл» для прошедшей (`/no-show`).

### Автоматический переход CONFIRMED → COMPLETED
- Реализован в бэкенде в `GET /api/bookings` (и продублирован в сводочных эндпоинтах), запускается при каждом чтении.
- Гарантирует консистентность статусов для отрисовки.

### Производительность
- Параллельные запросы к API.
- Автообновление без спиннера раз в 60 сек.
- Визуализация не использует сторонние тяжёлые календарные библиотеки, позиционирование простое и предсказуемое.
- Возможные улучшения: батч‑эндпоинты для расписаний/отсутствий, мемоизация `getBookingPosition` по дню.


