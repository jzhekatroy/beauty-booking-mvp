#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è beauty-booking
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è beauty-booking..."

# –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–µ —Å–æ–∑–¥–∞–µ–º .env –∏ –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º SQLite
if [ "${NODE_ENV}" = "production" ]; then
    echo "üîí PROD —Ä–µ–∂–∏–º: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ .env –∏ SQLite-–ø—É—Ç–∏"
else
    # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (DEV)
    if [ ! -f .env ]; then
        echo "üìù (DEV) –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
        cat > .env << EOF
DATABASE_URL="file:./dev.db"
JWT_SECRET="your-super-secret-jwt-key-change-in-production-$(date +%s)"
NODE_ENV="development"
EOF
        echo "‚úÖ (DEV) .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
    else
        echo "üìÅ .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if [ "${NODE_ENV}" != "production" ] && [ ! -f prisma/dev.db ]; then
    echo "üóÑÔ∏è (DEV) –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é..."
    npx prisma db push
    
    echo "üå± (DEV) –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."
    npm run db:seed
    
    echo "‚úÖ (DEV) –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞"
else
    echo "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ..."
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
    if [ -f scripts/protect-database.sh ]; then
        chmod +x scripts/protect-database.sh
        ./scripts/protect-database.sh
    fi
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    chmod 664 prisma/dev.db 2>/dev/null || echo "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
    
    # –ë–ï–ó–û–ü–ê–°–ù–´–ô —Ä–µ–∂–∏–º - –ù–ï –∏–∑–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É –µ—Å–ª–∏ –±–∞–∑–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
    echo "üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º: —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∞"
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    DB_BACKUP="/tmp/dev.db.backup_$(date +%Y%m%d_%H%M%S)"
    cp prisma/dev.db "$DB_BACKUP"
    echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $DB_BACKUP"
    
    # –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ù–ï –∏–∑–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
    if node -e "const {PrismaClient} = require('@prisma/client'); const prisma = new PrismaClient(); prisma.user.count().then(() => console.log('DB OK')).catch(() => process.exit(1)).finally(() => prisma.\$disconnect())" 2>/dev/null; then
        echo "‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ)
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
        
        # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        cat > temp_check_data.js << 'EOF'
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function checkAndAddMissingData() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
    const superAdmin = await prisma.user.findFirst({
      where: { email: 'admin@beauty-booking.com' }
    });
    
    if (!superAdmin) {
      console.log('–î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      // –ó–∞–ø—É—Å–∫–∞–µ–º seed —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      process.exit(1); // –°–∏–≥–Ω–∞–ª —á—Ç–æ –Ω—É–∂–µ–Ω seed
    } else {
      console.log('–ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç');
      process.exit(0); // –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ
    }
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error.message);
    process.exit(1); // –ù—É–∂–µ–Ω seed
  } finally {
    await prisma.$disconnect();
  }
}

checkAndAddMissingData();
EOF
        
        if node temp_check_data.js 2>/dev/null; then
            echo "‚úÖ –í—Å–µ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ"
        else
            echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –î–æ–ø–æ–ª–Ω—è–µ–º..."
            npm run db:seed 2>/dev/null || echo "Seed –≤—ã–ø–æ–ª–Ω–µ–Ω —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
        fi
        
        rm -f temp_check_data.js
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        rm -f "$DB_BACKUP"
        echo "üéâ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è"
    else
        echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
        
        if [ -f "$DB_BACKUP" ]; then
            cp "$DB_BACKUP" prisma/dev.db
            chmod 664 prisma/dev.db
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
            rm -f "$DB_BACKUP"
        else
            echo "‚ùå –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo "üõ°Ô∏è –ó–ê–©–ò–¢–ê: –í –ø—Ä–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ 'prisma migrate deploy'. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã —á–µ—Ä–µ–∑ db push –æ—Ç–∫–ª—é—á–µ–Ω–æ."
        fi
    fi
fi

echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üîó –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:"
echo "   - –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω: admin@beauty-booking.com / admin123"
echo "   - –ê–¥–º–∏–Ω —Å–∞–ª–æ–Ω–∞: salon@example.com / password123"
echo "   - –ú–∞—Å—Ç–µ—Ä–∞: anna@example.com, elena@example.com / password123"
echo ""
echo "üåê –°—Å—ã–ª–∫–∏:"
echo "   - –í—Ö–æ–¥: http://test.2minutes.ru/login"
echo "   - –ê–¥–º–∏–Ω–∫–∞: http://test.2minutes.ru/admin"
echo "   - –ó–∞–ø–∏—Å—å: http://test.2minutes.ru/book/beauty-salon"