#!/bin/bash

echo "üîß –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú –°–ï–†–í–ï–†–ê"
echo "============================================="
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /home/beautyapp/beauty-booking

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã npm/node
sudo pkill -f "npm start" 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã npm start –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
sudo pkill -f "next-server" 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã next-server –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
sudo pkill -f "node" 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã node –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000
echo "üîå –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000..."
sudo fuser -k 3000/tcp 2>/dev/null || echo "–ü–æ—Ä—Ç 3000 —É–∂–µ —Å–≤–æ–±–æ–¥–µ–Ω"

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
sleep 3

echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
sudo chown -R beautyapp:beautyapp /home/beautyapp/beauty-booking

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
chmod 664 prisma/dev.db 2>/dev/null || echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

echo "üóëÔ∏è –û—á–∏—â–∞–µ–º –∫—ç—à —Å–±–æ—Ä–∫–∏..."
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É
rm -rf .next

echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç –æ—Ç –∏–º–µ–Ω–∏ beautyapp..."
# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
if sudo -u beautyapp npm run build; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏"
    exit 1
fi

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ beautyapp..."
# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
sudo -u beautyapp bash -c "cd /home/beautyapp/beauty-booking && NODE_ENV=production PORT=3000 nohup npm start > app.log 2>&1 &"

echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
npm_pid=$(pgrep -f "npm start" || echo "")
if [ ! -z "$npm_pid" ]; then
    process_owner=$(ps -o user= -p $npm_pid 2>/dev/null || echo "unknown")
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å npm start –∑–∞–ø—É—â–µ–Ω (PID: $npm_pid)"
    echo "üë§ –í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞: $process_owner"
    
    if [ "$process_owner" = "beautyapp" ]; then
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    else
        echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $process_owner"
    fi
else
    echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    tail -10 app.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º endpoints
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å..."

for i in {1..10}; do
    if curl -f -s http://localhost:3000/api/health >/dev/null 2>&1; then
        echo "‚úÖ Health check –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!"
        break
    else
        echo "–ü–æ–ø—ã—Ç–∫–∞ $i/10: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç..."
        sleep 2
    fi
    
    if [ $i -eq 10 ]; then
        echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 20 —Å–µ–∫—É–Ω–¥"
        echo "üìã –õ–æ–≥–∏:"
        tail -20 app.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
    fi
done

echo ""
echo "üéâ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´!"
echo ""
echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –æ—Ç beautyapp"
echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏" 
echo "‚úÖ –ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://test.2minutes.ru"
echo "üîó –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:"
echo "   - –ê–¥–º–∏–Ω —Å–∞–ª–æ–Ω–∞: salon@example.com / password123"
echo "   - –ú–∞—Å—Ç–µ—Ä–∞: anna@example.com, elena@example.com / password123"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
ps aux | grep -E "(npm|node)" | grep beautyapp | head -3